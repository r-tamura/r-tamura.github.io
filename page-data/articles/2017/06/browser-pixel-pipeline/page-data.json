{"componentChunkName":"component---src-templates-blog-article-js","path":"/articles/2017/06/browser-pixel-pipeline/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://rtam.xyz","title":"Rの技術メモ","authorName":"r-tamura","authorDetail":"Web関連多めのソフトウェアエンジニアです。","githubId":"r-tamura","twitterId":"r_tamura30"}},"markdownRemark":{"html":"<p>ブラウザがHTMLをレンダリングする際に何を行っているか</p>\n<h2>The pixel pipeline</h2>\n<hr>\n<p>ブラウザがレンダリングをする際に行っていることは、大きく分けると次の5つになる:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.11042944785276%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAz0lEQVQI12NgYGBQY2BgUGJgYFDGgUFyFgwMDJoE1IGwCcPbbaJnv+zlO3RpttaeKu/Zhzrj5h5pDp15tMZ3yv46/6n7WiNmH+2InXugxXf+4ZhGj21+a6WOxKw2OOK7TPao1xLJPWGrNA9GrtY5ErFa57jvAoWdDP9P6fz/f0nl/+kp4b9aglb+n1ey8f/k1FX/24MX/u8KX/x/Rs66/7ML1//vi1j5P2qu6c/wXUr/C/e7/Q/fqvzff6Pk77Q95v8LD7r9z93v+D9+l+4JAKEpXnfUKpSSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pixel-pipeline\"\n        title=\"pixel-pipeline\"\n        src=\"/static/4052bd423d508eb6aaebaff495fd0351/a6d36/pixel-pipeline.png\"\n        srcset=\"/static/4052bd423d508eb6aaebaff495fd0351/222b7/pixel-pipeline.png 163w,\n/static/4052bd423d508eb6aaebaff495fd0351/ff46a/pixel-pipeline.png 325w,\n/static/4052bd423d508eb6aaebaff495fd0351/a6d36/pixel-pipeline.png 650w,\n/static/4052bd423d508eb6aaebaff495fd0351/42d54/pixel-pipeline.png 858w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li><strong>JavaScript</strong>: DOM操作で画面の見た目を変更にかかわるスクリプトの処理。</li>\n<li><strong>Style</strong>: 要素に対してどのCSSルールが適用されているかを計算するプロセス。\n<code class=\"language-text\">.class1</code>や<code class=\"language-text\">.class2</code>のように複数CSSセレクタが該当するものは、CSS適用の優先度から最終的にあてはまるルールを決定する。</li>\n<li><strong>Layout</strong>: 位置, 幅, 高さなど、要素がスクリーンのどのスペースを占めるかを決定するプロセス。Firefoxでは<code class=\"language-text\">reflow</code>と呼ばれる。\n<code class=\"language-text\">width</code>, <code class=\"language-text\">height</code>, <code class=\"language-text\">left</code>, <code class=\"language-text\">top</code> を変更するとLayout処理が発生する。</li>\n<li><strong>Paint</strong>: 描画処理呼び出しリストの作成と要素ピクセルに色で埋める処理(ラスタライズ)を行う。\nテキスト、色、画像、ボーダー、影を描画する処理を含む。\n<code class=\"language-text\">color</code>, <code class=\"language-text\">background-color</code>や<code class=\"language-text\">border-radius</code>, <code class=\"language-text\">border</code>, <code class=\"language-text\">box-shadow</code>などを変更するとPaintの処理が発生する。</li>\n<li><strong>Composite</strong>: ブラウザは複数のレイヤ(*1)と呼ばれる単位で描画されている。ページ全体にレイヤが正しい順序で描画を行うプロセス。\n<code class=\"language-text\">transform</code>, <code class=\"language-text\">opacity</code>の変更はこのプロセスのみを発生させる。</li>\n</ul>\n<p>再描画の際に実行されるプロセスが少ないほど高速となるので、アニメーションやスクロールなどの高負荷処理の部分では\n<strong>Composite</strong>のみを発生させるようチューニングするのが望ましい。</p>\n<h2>Side Navigationでパフォーマンス比較</h2>\n<hr>\n<p>Side Navigationをアニメーションで表示させてパフォーマンスの違いを確認する</p>\n<p>使用するHTML</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\">  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>app<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>side-menu<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>side-menu<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>header<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>menu-button<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>open<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h3>1. leftプロパティでアニメーション</h3>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token selector\">.side-menu</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">left</span><span class=\"token punctuation\">:</span> -102%<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">transition</span><span class=\"token punctuation\">:</span> left 150ms linear<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">.side-menu--open</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">left</span><span class=\"token punctuation\">:</span> -70%<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">transition</span><span class=\"token punctuation\">:</span> left 150ms linear<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>2. transformプロパティでアニメーション</h3>\n<p><code class=\"language-text\">will-change</code>プロパティでレイヤーを生成している。(非対応ブラウザには<code class=\"language-text\">transform: translateZ(0);</code>)</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token selector\">.side-menu</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">transform</span><span class=\"token punctuation\">:</span> <span class=\"token function\">translateX</span><span class=\"token punctuation\">(</span>-102%<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token property\">transition</span><span class=\"token punctuation\">:</span> transform 300ms linear<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">will-change</span><span class=\"token punctuation\">:</span> transform<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">.side-menu--open</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">transform</span><span class=\"token punctuation\">:</span> <span class=\"token function\">translateX</span><span class=\"token punctuation\">(</span>-30%<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token property\">transition</span><span class=\"token punctuation\">:</span> transform 300ms linear<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>比較結果</h2>\n<ol>\n<li>leftプロパティでアニメーション</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 74px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 137.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAcABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAEEBf/EABcBAQEBAQAAAAAAAAAAAAAAAAECAAP/2gAMAwEAAhADEAAAAe3cjBB02wYzKL//xAAcEAABBAMBAAAAAAAAAAAAAAABAAIDIRAREjH/2gAIAQEAAQUCFN6UluLyuyid4I2pKOH+/wD/xAAWEQEBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8BTI//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAaEAACAgMAAAAAAAAAAAAAAAABEAAhIDGR/9oACAEBAAY/AgHQmjx3j//EABwQAQADAAIDAAAAAAAAAAAAAAEAESExgUFRYf/aAAgBAQABPyFjGoeJSrpnIMyHUV6hXpMZV5r1ULo2cJPWQY/JcVmus//aAAwDAQACAAMAAAAQd+8y/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAExEP/aAAgBAwEBPxCMjIP/xAAXEQEAAwAAAAAAAAAAAAAAAAABABAR/9oACAECAQE/EAU2N//EABwQAQEBAQEAAwEAAAAAAAAAAAERADEhQXGx0f/aAAgBAQABPxDxMEesi00ZArqlIeHxMHEOPP5nTS9L1QE8EfwwNLPrSiRflWih8/p1QLzCLc0l7n//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"non-optimized\"\n        title=\"non-optimized\"\n        src=\"/static/1bc5cfa7f05a8ebce021394083b0344c/90294/non-optimized.jpg\"\n        srcset=\"/static/1bc5cfa7f05a8ebce021394083b0344c/90294/non-optimized.jpg 74w\"\n        sizes=\"(max-width: 74px) 100vw, 74px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ol start=\"2\">\n<li>transformプロパティでアニメーション</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 91px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 110.98901098901099%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAWABQDASIAAhEBAxEB/8QAGAABAQADAAAAAAAAAAAAAAAAAAMBBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB7eYEqkXZAB//xAAZEAACAwEAAAAAAAAAAAAAAAAAAQIREiD/2gAIAQEAAQUCTLLMzMzEpcf/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAVEQEBAAAAAAAAAAAAAAAAAAARIP/aAAgBAgEBPwEj/8QAGRAAAwADAAAAAAAAAAAAAAAAAAExIDJB/9oACAEBAAY/AiHUbIqx/8QAGxABAAICAwAAAAAAAAAAAAAAAQAhETEQIMH/2gAIAQEAAT8hAA3W+JygorRALzRpXvT/2gAMAwEAAgADAAAAEIQnPP/EABcRAAMBAAAAAAAAAAAAAAAAAAERIFH/2gAIAQMBAT8QR2P/xAAYEQACAwAAAAAAAAAAAAAAAAAAARARQf/aAAgBAgEBPxBM9Kn/xAAcEAEAAwADAQEAAAAAAAAAAAABABEhMUFxUdH/2gAIAQEAAT8QVw0A/TOf6iJXwKgktbVuQbhvZbUVfaIJmdSzcyCAE//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"optimized\"\n        title=\"optimized\"\n        src=\"/static/f94261efed0410d574b6d99a0091ea61/a3373/optimized.jpg\"\n        srcset=\"/static/f94261efed0410d574b6d99a0091ea61/a3373/optimized.jpg 91w\"\n        sizes=\"(max-width: 91px) 100vw, 91px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>大幅な差は確認できなかったが、transformプロパティでのアニメーションのほうがFPSが安定していることがわかった。\n今回は調査しなかったが<code class=\"language-text\">will-change</code>プロパティはGPUメモリにレイヤを格納し続けるのでスマートフォンなどでは電池消費が大きくなるそうで、\nアニメーション直前に<code class=\"language-text\">will-change</code>をオンにするのが良い方法らしい。</p>\n<hr>\n<p><strong>*1 レイヤー</strong>: GPUで処理される領域。GPUへテクスチャとしてアップロードされる。1つのレイヤが大きい場合はより小さいタイルという単位でアップロードされる。</p>\n<h1>参考</h1>\n<ul>\n<li><a href=\"https://developers.google.com/web/fundamentals/performance/rendering/\" target=\"_blank\" rel=\"nofollow\">Rendering Performance</a></li>\n<li><a href=\"https://medium.com/outsystems-experts/how-to-achieve-60-fps-animations-with-css3-db7b98610108\" target=\"_blank\" rel=\"nofollow\">Smooth as Butter: Achieving 60 FPS Animations with CSS3</a></li>\n<li><a href=\"https://csstriggers.com/\" target=\"_blank\" rel=\"nofollow\">CSS Triggers</a> どのCSSルールがどのプロセスを発生させるか</li>\n<li><a href=\"https://www.slideshare.net/yoshikawa_t/chrome-developer-tools-17787728\" target=\"_blank\" rel=\"nofollow\">Chrome Developer Toolsを使いこなそう！</a></li>\n<li><a href=\"http://qiita.com/cy-mitsuki/items/51a0a4c17b89154a7af2\" target=\"_blank\" rel=\"nofollow\">DevToolsのTimelineパネルを見ながら、レンダリングの仕組みを理解する</a></li>\n<li><a href=\"https://www.html5rocks.com/ja/tutorials/speed/layers/\" target=\"_blank\" rel=\"nofollow\">Accelerated Rendering in Chrome</a> Chromeのレイヤー概念とGPUについて</li>\n</ul>","frontmatter":{"tags":["browser","css","html"],"title":"The pixel pipeline","date":"17 June, 2017"},"fields":{"slug":"/articles/2017/06/browser-pixel-pipeline/"}}},"pageContext":{"slug":"/articles/2017/06/browser-pixel-pipeline/"}},"staticQueryHashes":["2340977587"]}