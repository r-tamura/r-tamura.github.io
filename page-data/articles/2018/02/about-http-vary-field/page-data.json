{"componentChunkName":"component---src-templates-blog-article-js","path":"/articles/2018/02/about-http-vary-field/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://rtam.xyz","title":"Rの技術メモ","authorName":"r-tamura","authorDetail":"Web関連多めのソフトウェアエンジニアです。","githubId":"r-tamura","twitterId":"r_tamura30"}},"markdownRemark":{"html":"<p>HTTP Varyヘッダとはクライアントとサーバ間(以下 オリジンサーバ)にCDN等のキャッシュサーバへキャッシュの扱い方を指定するためのフィールド。</p>\n<h1>背景と問題</h1>\n<p>同じURLへのアクセスでもリクエストに含まれるAccept-Languageヘッダによって言語ごとに異なるレスポンスをサーバが返す場合、\nキャッシュサーバが<strong>URLのみ</strong>で  「キャッシュを利用するか」/「オリジンサーバへ問い合わせをするか」を判断してしまうと、\nAccept-Languageヘッダで指定された言語にオリジンサーバが対応しているにもかかわらず、\nキャッシュサーバが間違ったレスポンスを返してしまう可能性がある。これを解決するのが<code class=\"language-text\">Vary</code>フィールド。</p>\n<h1>Varyフィールド</h1>\n<p><strong>Vary</strong>フィールドは<a href=\"https://tools.ietf.org/html/rfc7231#section-7.1.4\" target=\"_blank\" rel=\"nofollow\">RFC7231</a>で定義されている。\n以下の図はVaryフィールドを使った異なる言語に対するレスポンスの振り分けの例。<br>\nクライアントから3回リクエストが送信されていますが、Varyフィールドで言語ごとのレスポンスをキャッシュサーバへキャッシュしている。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 138.65030674846625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"vary-flow-diagram\"\n        title=\"vary-flow-diagram\"\n        src=\"/static/0cc8ac3ce135855d81980eb6fb4ef1cc/a6d36/vary-flow-diagram.png\"\n        srcset=\"/static/0cc8ac3ce135855d81980eb6fb4ef1cc/222b7/vary-flow-diagram.png 163w,\n/static/0cc8ac3ce135855d81980eb6fb4ef1cc/ff46a/vary-flow-diagram.png 325w,\n/static/0cc8ac3ce135855d81980eb6fb4ef1cc/a6d36/vary-flow-diagram.png 650w,\n/static/0cc8ac3ce135855d81980eb6fb4ef1cc/1d69c/vary-flow-diagram.png 750w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>> 1回目のリクエスト</li>\n</ul>\n<p>キャッシュサーバにキャッシュがない状態ですのでキャッシュサーバからオリジンサーバへ問い合わせが発生する。その際、オリジンサーバは<code class=\"language-text\">Vary: Accept-Language</code>をレスポンスに付加することで、キャッシュサーバはURLだけでなく、URL + <code class=\"language-text\">Accept-Language: ja</code>をキーとしてレスポンスをキャッシュする。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Content-Language: ja\nVary: Accept-Language</code></pre></div>\n<ul>\n<li>> 2回目のリクエスト</li>\n</ul>\n<p>キャッシュサーバに<code class=\"language-text\">Accept-Language: ja</code>のリクエストが来ましたが、すでにキャッシュに登録されているためキャッシュのレスポンスをクライアントへ返する。<strong>オリジンサーバへのリクエストは発生しません</strong>。</p>\n<ul>\n<li>> 3回目のリクエスト</li>\n</ul>\n<p><code class=\"language-text\">Accept-Language: en</code>のリクエストが来ましたが、キャッシュサーバにはenのキャッシュはないので、オリジンサーバへ問い合わせ、帰ってきたレスポンスをenでキャッシュして、クライアントへ返する。</p>\n<h1>まとめ</h1>\n<p>言語によるレスポンス振り分けにおけるキャッシュサーバのキャッシュ制御についての例を確認しました。Varyフィールドは<code class=\"language-text\">Accept-Language</code>だけでなく、他のフィールド指定や複数のフィールドをカンマで区切って指定することもできる。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Vary: Accept-Encoding, Accept-Language</code></pre></div>\n<p>なお、Varyヘッダではオリジンサーバの対応する形式などをキャッシュサーバへ伝えることができないので、それをできるようにする仕様HTTP Variantsというものも提案されている。</p>\n<h1>参考</h1>\n<ul>\n<li><a href=\"http://asnokaze.hatenablog.com/entry/2017/10/01/015550\" target=\"_blank\" rel=\"nofollow\">キャッシュサーバの効率を改善するHTTP Variantsという提案仕様 - ASnoKaze blog</a></li>\n</ul>","frontmatter":{"tags":["http"],"title":"HTTP Varyヘッダについて","date":"17 February, 2018"},"fields":{"slug":"/articles/2018/02/about-http-vary-field/"}}},"pageContext":{"slug":"/articles/2018/02/about-http-vary-field/"}},"staticQueryHashes":["2340977587"]}